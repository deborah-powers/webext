<!DOCTYPE html><html><head>
	<title></title>
	<meta name='viewport' content='width=device-width,initial-scale=1'/>
	<meta charset='utf-8'/>
	<base target='_blank'>
	<link rel='stylesheet' type='text/css' href='main-style.css' />
<style type='text/css'>
	div {
		border: none;
		background-color: #FEE;
		width: 50%;
		height: 4em;
		display: inline-block;
		margin: 0;
	}
	section {
		display: grid;
		grid-template-rows: 2em 1fr 1fr;
		grid-template-columns: 1fr 1fr;
		grid-auto-flow: column;
	}
	h2 { grid-column: 1/4; }
	section#contrast {
		grid-template-columns: 1fr 1fr 1fr;
		grid-auto-flow: row;
	}
	input {
		width: 100%;
		height: 100%;
		border-radius: 0;
		margin: 0;
	}
	p.OK {
		background-color: deeppink;
		color: ivory;
	}
	/*
	input[type='color'] {
		border: none;
		border-color: transparent;
		appearance: none;
		-moz-appearance: none;
		-o-appearance: none;
		-webkit-appearance: none;
	}
	input[type='color']::-moz-color-swatch {
		border: none;
	}
	input[type='color']::-webkit-color-swatch-wrapper {
		padding: 0;
		border-radius: 0;
	}
	input[type='color']::-webkit-color-swatch { border: none; }
	*/
</style></head><body>
	<div id='col-a-block'></div><div id='col-o-block'></div>
	<section>
		<h2>entrez la première couleur</h2>
		<p>choisir:</p><input type='color' id='col-a-picker' onchange='pickColor("a",this.value)' />
		<p>code couleur:</p><input type='text' id='col-a-code' onchange='pickColorCode("a",this.value)' />
	</section>
	<section>
		<h2>entrez la seconde couleur</h2>
		<p>choisir:</p><input type='color' id='col-o-picker' onchange='pickColor("o",this.value)' />
		<p>code couleur:</p><input type='text' id='col-o-code' onchange='pickColorCode("o",this.value)' />
	</section>
	<section id='contrast'>
		<h2>qualité du contraste: $contrast:1</h2>
		<p>.</p><p>AA</p><p>AAA</p>
		<p>grand texte (>18pt)</p><p class='$grandTextAA'>$grandTextAA</p><p class='$grandTextAAA'>$grandTextAAA</p>
		<p>petit texte (>14pt) ou gras</p><p class='$petitTextAA'>$petitTextAA</p><p class='$petitTextAAA'>$petitTextAAA</p>
	</section>
	<h2>choisir dans la page</h2>
	<button onclick='chooseFromPage()'>choisir</button>
</body><script type='text/javascript'>
	// ------------------------ calculer le contraste ------------------------
	function computefromSrgb (colSrgb){
		var color =0;
		if (colSrgb > 0.03928){
			color = colSrgb + 0.055;
			color /= 1.055;
			color = color **2.4;
		}
		else color = colSrgb / 12.92;
		return color;
	}
	function luxFromRgb (rgbArray){
		rgbArray[0] /= 255.0;
		rgbArray[1] /= 255.0;
		rgbArray[2] /= 255.0;
		const lux = 0.2126 * computefromSrgb (rgbArray[0]) + 0.7152 * computefromSrgb (rgbArray[1]) + 0.0722 * computefromSrgb (rgbArray[2]);
		return lux;
	}
	function computeContrast (rgbA, rgbO){
		const luxa = luxFromRgb (rgbA);
		const luxo = luxFromRgb (rgbO);
		if (luxa > luxo) return (luxa + 0.05) / (luxo + 0.05);
		else return (luxo + 0.05) / (luxa + 0.05);
	}
	// ------------------------ préparer les couleurs ------------------------
	function validateHex (hexCode){
		// longueur du code
		if (hexCode[0] === '#') hexCode = hexCode.substring (1);
		// supprimer la transparence, compliquée à gérer
		if (hexCode.length ===4) hexCode = hexCode.substring (0,3);
		else if (hexCode.length ===8) hexCode = hexCode.substring (0,6);
		if (hexCode.length ===3) hexCode = hexCode[0] + hexCode[0] + hexCode[1] + hexCode[1] + hexCode[2] + hexCode[2];
		else if (hexCode.length !==6) hexCode = 'CEFADA';
		// lettres du code
		hexCode = hexCode.toUpperCase();
		const values = '0123456789ABCDEF';
		var colorOk = true;
		var c=1;
		while (c< hexCode.length && colorOk){
			if (! values.includes (hexCode[c])) colorOk = false;
			c+=1;
		}
		if (! colorOk) hexCode = 'CEFADA';
		return '#'+ hexCode;
	}
	function rgbFromHex (hexCode){
		// hexCode = #123456
		const hexArray = [ hexCode[1] + hexCode[2], hexCode[3] + hexCode[4], hexCode[5] + hexCode[6] ];
		var rgbArray =[ parseInt (hexArray[0], 16), parseInt (hexArray[1], 16), parseInt (hexArray[2], 16) ];
		return rgbArray;
	}
	function rgbToHex (rgbArray){
		rgbArray[0] = rgbArray[0].toString (16);
		if (rgbArray[0].length ===1) rgbArray[0] ='0'+ rgbArray[2];
		rgbArray[1] = rgbArray[1].toString (16);
		if (rgbArray[1].length ===1) rgbArray[1] ='0'+ rgbArray[2];
		rgbArray[2] = rgbArray[2].toString (16);
		if (rgbArray[2].length ===1) rgbArray[2] ='0'+ rgbArray[2];
		var hexCode = '#'+ rgbArray[0] + rgbArray[1] + rgbArray[2];
		hexCode = hexCode.toUpperCase();
		return hexCode;
	}
	function rgbFromString (rgbString){
		// rgbString = rgb(1,2,3)
		if (rgbString.includes ('rgba')) rgbString = rgbString.substring (5, rgbString.length -1);
		else rgbString = rgbString.substring (4, rgbString.length -1);
		var rgbArray = rgbString.split (',');
		rgbArray[0] = parseInt (rgbArray[0]);
		rgbArray[1] = parseInt (rgbArray[1]);
		rgbArray[2] = parseInt (rgbArray[2]);
		if (rgbArray.length ===3) rgbArray.push (1.0);
		else rgbArray[3] = parseFloat (rgbArray[3]);
		return rgbArray;
	}
	function rgbFromString_va (rgbString){
		// rgbString = rgb(1,2,3)
		if (rgbString.includes ('rgba')){
			rgbString = rgbString.substring (5, rgbString.length -1);
			const d= rgbString.lastIndexOf (',');
			rgbString = rgbString.substring (0,d);
		}
		else rgbString = rgbString.substring (4, rgbString.length -1);
		var rgbArray = rgbString.split (',');
		rgbArray[0] = parseInt (rgbArray[0]);
		rgbArray[1] = parseInt (rgbArray[1]);
		rgbArray[2] = parseInt (rgbArray[2]);
		return rgbArray;
	}
	// ------------------------ récupérer les couleurs entrées par l'utilisateur ------------------------
	function rgbArrayToString (rgbArray){
		return 'rgb(' + rgbArray[0].toString() +','+ rgbArray[1].toString() +','+ rgbArray[2].toString() +')';
	}
	function printColor (blocLetter, hexCode){
		document.getElementById ('col-' + blocLetter + '-block').style.backgroundColor = hexCode;
		document.getElementById ('col-' + blocLetter + '-picker').value = hexCode;
		document.getElementById ('col-' + blocLetter + '-code').value = hexCode;
	}
	function pickColor (blocLetter, hexCode){
		// afficher la couleur
		printColor (blocLetter, hexCode);
		// comparer les couleurs
		var hexCode2 = hexCode;
		if (blocLetter === 'a') hexCode2 = document.getElementById ('col-o-picker').value;
		else hexCode2 = document.getElementById ('col-a-picker').value;
		var rgbA = rgbFromHex (hexCode);
		var rgbO = rgbFromHex (hexCode2);
		printContrast (rgbA, rgbO);
	}
	function pickColorCode (blocLetter, hexCode){
		hexCode = validateHex (hexCode);
		pickColor (blocLetter, hexCode);
	}
	// ------------------------ récupérer les couleurs sur la page ------------------------
	function chooseFromPage(){ document.body.activeColorSelection(); }
	HTMLElement.prototype.activeColorSelection = function(){
		this.addEventListener ('mousedown', selectColor);
		for (var c=0; c< this.children.length; c++) this.children[c].activeColorSelection();
	}
	HTMLElement.prototype.stopColorSelection = function(){
		this.removeEventListener ('mousedown', selectColor);
		for (var c=0; c< this.children.length; c++) this.children[c].stopColorSelection();
	}
	HTMLElement.prototype.computeRgbaColor = function (rgbaArrayText, rgbaArrayBg){
		const style = window.getComputedStyle (this);
		if (rgbaArrayText[3] <1){
			var rgbTmpText = rgbFromString (style.color);
			rgbTmpText[0] *= rgbTmpText[3];
			rgbTmpText[1] *= rgbTmpText[3];
			rgbTmpText[2] *= rgbTmpText[3];
			rgbaArrayText[0] += rgbTmpText[0];
			rgbaArrayText[1] += rgbTmpText[1];
			rgbaArrayText[2] += rgbTmpText[2];
			rgbaArrayText[3] += rgbTmpText[3];
		}
		if (rgbaArrayBg[3] <1){
			var rgbTmpBg = rgbFromString (style.backgroundColor);
			console.log (this.tagName, rgbTmpBg);
			rgbTmpBg[0] *= rgbTmpBg[3];
			rgbTmpBg[1] *= rgbTmpBg[3];
			rgbTmpBg[2] *= rgbTmpBg[3];
			rgbaArrayBg[0] += rgbTmpBg[0];
			rgbaArrayBg[1] += rgbTmpBg[1];
			rgbaArrayBg[2] += rgbTmpBg[2];
			rgbaArrayBg[3] += rgbTmpBg[3];
		}
		if (rgbaArrayText[3] <1 || rgbaArrayBg[3] <1) this.parentElement.computeRgbaColor (rgbaArrayText, rgbaArrayBg);
		else{
			if (rgbaArrayText[3] >1){
				rgbaArrayText[0] /= rgbaArrayText[3];
				rgbaArrayText[1] /= rgbaArrayText[3];
				rgbaArrayText[2] /= rgbaArrayText[3];
			}
			if (rgbaArrayBg[3] >1){
				rgbaArrayBg[0] /= rgbaArrayBg[3];
				rgbaArrayBg[1] /= rgbaArrayBg[3];
				rgbaArrayBg[2] /= rgbaArrayBg[3];
			}
		}
		console.log (this.tagName, rgbaArrayText, rgbaArrayBg);
		return [ rgbaArrayText[0], rgbaArrayText[1], rgbaArrayText[2], rgbaArrayBg[0], rgbaArrayBg[1], rgbaArrayBg[2] ];
	}
	function selectColor (event){
		const rgbArray = event.target.computeRgbaColor ([0,0,0,0], [0,0,0,0]);
		const rgbArrayText =[ rgbArray[0], rgbArray[1], rgbArray[2] ];
		const rgbArrayBg =[ rgbArray[3], rgbArray[4], rgbArray[4] ];
		/*
		const rgbArrayText = rgbFromString (style.color);
		const rgbArrayBg = rgbFromString (style.backgroundColor);
		*/
		document.body.stopColorSelection();
		// afficher les couleurs
		console.log (rgbArrayText, rgbArrayBg);
		const hexText = rgbToHex (rgbArrayText);
		const hexBg = rgbToHex (rgbArrayBg);
		printColor ('a', hexText);
		printColor ('o', hexBg);
		printContrast (rgbArrayText, rgbArrayBg);
	}
	// ------------------------ afficher le contraste ------------------------

	const contrastBlock ="<h2>qualité du contraste: $contrast:1</h2><p>.</p><p>AA</p><p>AAA</p><p>grand texte (>18pt)</p><p class='$grandTextAA'>$grandTextAA</p><p class='$grandTextAAA'>$grandTextAAA</p><p>petit texte (>14pt) ou gras</p><p class='$petitTextAA'>$petitTextAA</p><p class='$petitTextAAA'>$petitTextAAA</p>";
	function printContrast (rgbA, rgbO){
		var lux = computeContrast (rgbA, rgbO);
		lux = Math.round (lux * 10) /10;
		const sectionConstast = document.getElementById ('contrast');
		sectionConstast.innerHTML = contrastBlock.replace ('$contrast', lux);
		if (lux <3){
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAA', 'KO');
		}
		else if (lux <4.5){
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAA', 'KO');
		}
		else if (lux <7){
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAAA', 'KO');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAA', 'OK');
		}
		else{
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$grandTextAA', 'OK');
			sectionConstast.innerHTML = sectionConstast.innerHTML.replaceAll ('$petitTextAA', 'OK');
		}
	}
	// pour les jeux de mots: ABCDEFGILOS
	pickColor ('a', '#0AF0AF');
	pickColor ('o', '#CEFADA');
</script></html>